<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ok to Shop - El Juego</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #fef6df; /* Color de fondo principal */
            color: #09503d; /* Color de texto principal */
            overflow: hidden;
        }
        .game-container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        canvas {
            background-color: #efeff7; /* Color de fondo del canvas */
            display: block;
            width: 100%;
            height: auto;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }
        .ui-panel {
            background-color: #bde7de;
            color: #09503d;
            padding: 1rem 1.5rem;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
        }
        .modal {
            background-color: rgba(9, 80, 61, 0.8);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: #fef6df;
            color: #09503d;
        }
        .btn {
            background-color: #ffc74a;
            color: #09503d;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        .btn-danger {
            background-color: #f4275d;
            color: white;
        }
        .allergy-tag {
            background-color: #f4275d;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .allergy-tag-modal {
            background-color: #612680;
            font-size: 1.1rem;
        }
        .life-heart {
            color: #f4275d;
            font-size: 1.75rem;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="game-wrapper" class="relative w-full max-w-3xl">
        <!-- Pantalla de Inicio -->
        <div id="start-screen" class="modal absolute inset-0 z-30 flex items-center justify-center rounded-2xl">
            <div class="modal-content text-center p-8 rounded-2xl shadow-lg max-w-md mx-auto">
                <h1 class="text-4xl font-bold mb-2">¬°Bienvenido a Ok to Shop!</h1>
                <p class="mb-6">Ayuda a nuestro amigo a comer solo lo que puede. ¬°Cuidado con las alergias!</p>
                <h2 class="text-xl font-semibold mb-2">Instrucciones:</h2>
                <p class="mb-6 text-left">
                    - Usa las <kbd>teclas de flecha</kbd> o <kbd>desliza el dedo</kbd> para moverte.<br>
                    - Atrapa la comida segura para ganar puntos.<br>
                    - ¬°Consigue 200 puntos para pasar de nivel!
                </p>
                <button id="start-button" class="btn text-xl">Empezar a Jugar</button>
            </div>
        </div>
        
        <!-- Pantalla de Inicio de Nivel -->
        <div id="level-start-screen" class="modal absolute inset-0 z-20 hidden items-center justify-center rounded-2xl">
            <div class="modal-content text-center p-8 rounded-2xl shadow-lg max-w-md mx-auto">
                <h1 id="level-start-title" class="text-4xl font-bold mb-4">Nivel 1</h1>
                <p class="mb-4 text-lg">Para este nivel, tus alergias son:</p>
                <div id="level-start-allergies" class="flex flex-wrap justify-center gap-3 mb-6">
                    <!-- Las alergias se insertar√°n aqu√≠ -->
                </div>
                <button id="level-start-button" class="btn text-xl">¬°A Jugar!</button>
            </div>
        </div>

        <!-- Pantalla de Game Over -->
        <div id="game-over-screen" class="modal absolute inset-0 z-20 hidden items-center justify-center rounded-2xl">
            <div class="modal-content text-center p-8 rounded-2xl shadow-lg max-w-md mx-auto">
                <h1 class="text-4xl font-bold mb-2 text-red-500">¬°Juego Terminado!</h1>
                <p class="text-xl mb-4">Puntuaci√≥n Final: <span id="final-score" class="font-bold">0</span></p>
                <button id="restart-button" class="btn text-xl">Jugar de Nuevo</button>
            </div>
        </div>
        
        <!-- Contenedor del Juego -->
        <div id="game-container" class="game-container opacity-0 transition-opacity duration-500">
            <div class="ui-panel">
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <div class="flex-grow">
                        <h2 class="font-bold text-lg">Nivel: <span id="level">1</span></h2>
                        <p class="font-semibold text-2xl">Puntos: <span id="score">0</span></p>
                    </div>
                    <div class="text-right">
                        <h2 class="font-bold text-lg">Vidas:</h2>
                        <div id="lives" class="flex justify-end items-center gap-1"></div>
                    </div>
                </div>
                <div class="mt-4">
                    <h3 class="font-bold text-sm mb-2">Tus Alergias (¬°Evita esto!):</h3>
                    <div id="allergies-list" class="flex flex-wrap gap-2"></div>
                </div>
            </div>
            <canvas id="gameCanvas"></canvas>
        </div>
    </div>

    <script>
        // --- ELEMENTOS DEL DOM ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        const startScreen = document.getElementById('start-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const levelStartScreen = document.getElementById('level-start-screen');
        const gameContainer = document.getElementById('game-container');

        const startButton = document.getElementById('start-button');
        const restartButton = document.getElementById('restart-button');
        const levelStartButton = document.getElementById('level-start-button');

        const scoreEl = document.getElementById('score');
        const livesEl = document.getElementById('lives');
        const levelEl = document.getElementById('level');
        const allergiesListEl = document.getElementById('allergies-list');
        const finalScoreEl = document.getElementById('final-score');
        const levelStartTitleEl = document.getElementById('level-start-title');
        const levelStartAllergiesEl = document.getElementById('level-start-allergies');

        let canvasWidth, canvasHeight;

        // --- ESTADO DEL JUEGO ---
        let score, lives, level, isGameOver, gameLoopId;
        let player, foods, keys = {};

        // --- CONFIGURACI√ìN DEL JUEGO ---
        const playerWidth = 50;
        const playerHeight = 75;
        const playerSpeed = 8;
        const foodSize = 35;
        const foodBaseSpeed = 1.5;
        const foodSpawnInterval = 1000; // ms
        let lastFoodSpawn = 0;

        // --- DATOS: ALERGIAS Y ALIMENTOS ---
        const ALL_ALLERGIES = [
            'Vegano', 'Vegetariano', 'Celiaco', 'Sin Lactosa', 'Pecetariano', 
            'Sin huevo', 'Sin soya', 'Sin Sellos', 'Sin mariscos', 
            'Sin pescados', 'Sin frutos secos'
        ];
        const FOOD_DATABASE = [
            { emoji: 'üçé', name: 'Manzana', properties: [] }, { emoji: 'ü•¶', name: 'Br√≥coli', properties: [] },
            { emoji: 'ü•ï', name: 'Zanahoria', properties: [] }, { emoji: 'üçá', name: 'Uvas', properties: [] },
            { emoji: 'üçì', name: 'Fresa', properties: [] }, { emoji: 'üçó', name: 'Pollo', properties: ['meat'] },
            { emoji: 'ü•©', name: 'Carne', properties: ['meat'] }, { emoji: 'üç£', name: 'Salm√≥n', properties: ['fish'] },
            { emoji: 'üêü', name: 'Pescado', properties: ['fish'] }, { emoji: 'üç§', name: 'Camar√≥n', properties: ['shellfish'] },
            { emoji: 'ü¶û', name: 'Langosta', properties: ['shellfish'] }, { emoji: 'ü•ö', name: 'Huevo', properties: ['egg'] },
            { emoji: 'ü•õ', name: 'Leche', properties: ['dairy'] }, { emoji: 'ÔøΩ', name: 'Queso', properties: ['dairy'] },
            { emoji: 'üçû', name: 'Pan', properties: ['gluten'] }, { emoji: 'üçù', name: 'Pasta', properties: ['gluten'] },
            { emoji: 'ü•°', name: 'Tofu', properties: ['soy'] }, { emoji: 'ü•ú', name: 'Man√≠', properties: ['nuts'] },
            { emoji: 'üå∞', name: 'Casta√±a', properties: ['nuts'] }, { emoji: 'üç©', name: 'Dona', properties: ['gluten', 'dairy', 'egg', 'unhealthy'] },
            { emoji: 'üçï', name: 'Pizza', properties: ['gluten', 'dairy', 'meat', 'unhealthy'] }, { emoji: 'üçî', name: 'Hamburguesa', properties: ['gluten', 'meat', 'unhealthy'] },
            { emoji: 'üçü', name: 'Papas Fritas', properties: ['unhealthy'] }, { emoji: 'üéÇ', name: 'Pastel', properties: ['gluten', 'dairy', 'egg', 'unhealthy'] },
        ];
        let currentAllergies = [];

        // --- L√ìGICA PRINCIPAL DEL JUEGO ---

        function initGame() {
            resizeCanvas();
            score = 0;
            lives = 3;
            level = 1;
            isGameOver = false;
            foods = [];
            
            player = {
                x: canvasWidth / 2 - playerWidth / 2,
                y: canvasHeight - playerHeight - 10,
                width: playerWidth,
                height: playerHeight,
                dx: 0
            };
            
            startScreen.classList.add('hidden');
            gameOverScreen.classList.add('hidden');
            gameContainer.classList.remove('opacity-0');
            
            prepareLevel(level);
        }

        function prepareLevel(newLevel) {
            level = newLevel;
            currentAllergies = [];
            const shuffledAllergies = [...ALL_ALLERGIES].sort(() => 0.5 - Math.random());
            
            // Dificultad progresiva de alergias
            const allergyCount = Math.min(level, 3);
            
            for (let i = 0; i < allergyCount; i++) {
                currentAllergies.push(shuffledAllergies[i]);
            }
            
            foods = []; // Limpiar comida del nivel anterior
            updateUI();
            showLevelStartScreen();
        }

        function showLevelStartScreen() {
            levelStartTitleEl.textContent = `Nivel ${level}`;
            levelStartAllergiesEl.innerHTML = '';
            currentAllergies.forEach(allergy => {
                const tag = document.createElement('span');
                tag.className = 'allergy-tag allergy-tag-modal';
                tag.textContent = allergy;
                levelStartAllergiesEl.appendChild(tag);
            });
            levelStartScreen.classList.remove('hidden');
            levelStartScreen.classList.add('flex');
        }
        
        function startLevel() {
            levelStartScreen.classList.add('hidden');
            levelStartScreen.classList.remove('flex');
            lastFoodSpawn = performance.now(); // Resetear el temporizador de spawn
            gameLoopId = requestAnimationFrame(gameLoop);
        }

        function isUnsafe(food) {
            const props = food.properties;
            for (const allergy of currentAllergies) {
                switch (allergy) {
                    case 'Vegano': if (props.includes('meat') || props.includes('fish') || props.includes('shellfish') || props.includes('egg') || props.includes('dairy')) return true; break;
                    case 'Vegetariano': if (props.includes('meat') || props.includes('fish') || props.includes('shellfish')) return true; break;
                    case 'Celiaco': if (props.includes('gluten')) return true; break;
                    case 'Sin Lactosa': if (props.includes('dairy')) return true; break;
                    case 'Pecetariano': if (props.includes('meat')) return true; break;
                    case 'Sin huevo': if (props.includes('egg')) return true; break;
                    case 'Sin soya': if (props.includes('soy')) return true; break;
                    case 'Sin Sellos': if (props.includes('unhealthy')) return true; break;
                    case 'Sin mariscos': if (props.includes('shellfish')) return true; break;
                    case 'Sin pescados': if (props.includes('fish')) return true; break;
                    case 'Sin frutos secos': if (props.includes('nuts')) return true; break;
                }
            }
            return false;
        }

        function spawnFood() {
            const randomFoodTemplate = FOOD_DATABASE[Math.floor(Math.random() * FOOD_DATABASE.length)];
            foods.push({
                ...randomFoodTemplate,
                x: Math.random() * (canvasWidth - foodSize),
                y: -foodSize,
                // Dificultad progresiva de velocidad
                speed: foodBaseSpeed + (level * 0.25) + Math.random() * (level / 2)
            });
        }

        function updatePlayer() {
            player.x += player.dx;
            if (player.x < 0) player.x = 0;
            if (player.x + player.width > canvasWidth) player.x = canvasWidth - player.width;
        }

        function updateFoods() {
            for (let i = foods.length - 1; i >= 0; i--) {
                const food = foods[i];
                food.y += food.speed;

                if (food.y + foodSize > player.y && food.x < player.x + player.width && food.x + foodSize > player.x) {
                    if (isUnsafe(food)) {
                        lives--;
                        showFeedbackMessage('¬°Auch!', '#f4275d');
                    } else {
                        score += 10;
                        showFeedbackMessage('+10', '#09503d');
                    }
                    foods.splice(i, 1);
                    updateUI();
                    continue;
                }
                if (food.y > canvasHeight) foods.splice(i, 1);
            }
        }
        
        let feedbackMessages = [];
        function showFeedbackMessage(text, color) {
            feedbackMessages.push({ text, color, x: player.x + player.width / 2, y: player.y, alpha: 1, life: 60 });
        }

        function updateAndDrawFeedback() {
            for (let i = feedbackMessages.length - 1; i >= 0; i--) {
                const msg = feedbackMessages[i];
                msg.y -= 1;
                msg.alpha = msg.life / 60;
                msg.life--;

                ctx.font = 'bold 24px Poppins';
                ctx.fillStyle = `rgba(${hexToRgb(msg.color)}, ${msg.alpha})`;
                ctx.textAlign = 'center';
                ctx.fillText(msg.text, msg.x, msg.y);

                if (msg.life <= 0) feedbackMessages.splice(i, 1);
            }
        }
        
        function hexToRgb(hex) {
            let r = 0, g = 0, b = 0;
            if (hex.length == 7) {
                r = "0x" + hex[1] + hex[2];
                g = "0x" + hex[3] + hex[4];
                b = "0x" + hex[5] + hex[6];
            }
            return `${+r},${+g},${+b}`;
        }

        function checkGameState() {
            if (lives <= 0) {
                isGameOver = true;
                cancelAnimationFrame(gameLoopId);
                finalScoreEl.textContent = score;
                gameOverScreen.classList.remove('hidden');
                gameOverScreen.classList.add('flex');
                gameContainer.classList.add('opacity-0');
            }

            if (score >= 200) {
                cancelAnimationFrame(gameLoopId);
                score = 0;
                showFeedbackMessage(`¬°Nivel ${level+1}!`, '#612680');
                prepareLevel(level + 1);
            }
        }

        // --- FUNCIONES DE DIBUJADO ---

        function drawPlayer() {
            const x = player.x, y = player.y, w = player.width, h = player.height;
            ctx.fillStyle = '#09503d';
            ctx.beginPath();
            ctx.arc(x + w / 2, y + w / 2, w / 2, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(x + w * 0.3, y + w * 0.4, w * 0.1, 0, Math.PI * 2);
            ctx.arc(x + w * 0.7, y + w * 0.4, w * 0.1, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(x + w / 2, y + w * 0.6, w * 0.25, 0.2 * Math.PI, 0.8 * Math.PI);
            ctx.stroke();
            const bodyBottomY = y + w, legTopY = bodyBottomY - 10, armY = y + w / 2 + 10;
            ctx.strokeStyle = '#09503d';
            ctx.lineWidth = 6;
            ctx.lineCap = 'round';
            ctx.beginPath();
            ctx.moveTo(x + w/2, legTopY);
            ctx.lineTo(x + w * 0.2, y + h);
            ctx.moveTo(x + w/2, legTopY);
            ctx.lineTo(x + w * 0.8, y + h);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x + w/2, armY);
            ctx.lineTo(x - 5, y + h * 0.6);
            ctx.moveTo(x + w/2, armY);
            ctx.lineTo(x + w + 5, y + h * 0.6);
            ctx.stroke();
        }

        function drawFoods() {
            ctx.font = `${foodSize}px sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            foods.forEach(food => ctx.fillText(food.emoji, food.x + foodSize / 2, food.y + foodSize / 2));
        }

        function updateUI() {
            scoreEl.textContent = score;
            levelEl.textContent = level;
            livesEl.innerHTML = Array(3).fill(0).map((_, i) => 
                `<span class="life-heart" style="opacity: ${i < lives ? 1 : 0.2};">‚ô•</span>`
            ).join('');
            allergiesListEl.innerHTML = currentAllergies.map(allergy => 
                `<span class="allergy-tag">${allergy}</span>`
            ).join('');
        }

        // --- BUCLE PRINCIPAL DEL JUEGO ---

        function gameLoop(timestamp) {
            if (isGameOver) return;
            gameLoopId = requestAnimationFrame(gameLoop);
            
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);

            updatePlayer();
            updateFoods();
            
            if (timestamp - lastFoodSpawn > foodSpawnInterval) {
                spawnFood();
                lastFoodSpawn = timestamp;
            }
            
            drawPlayer();
            drawFoods();
            updateAndDrawFeedback();

            checkGameState();
        }

        // --- MANEJO DE EVENTOS ---
        
        function handleKeyDown(e) { keys[e.key] = true; updatePlayerMovement(); }
        function handleKeyUp(e) { keys[e.key] = false; updatePlayerMovement(); }
        
        function updatePlayerMovement() {
            if (keys['ArrowLeft'] || keys['a']) player.dx = -playerSpeed;
            else if (keys['ArrowRight'] || keys['d']) player.dx = playerSpeed;
            else player.dx = 0;
        }
        
        let touchStartX = null;
        function handleTouchStart(e) { if(e.touches.length > 0) touchStartX = e.touches[0].clientX; }
        function handleTouchMove(e) {
            if (touchStartX === null) return;
            const rect = canvas.getBoundingClientRect();
            const touchXInCanvas = e.touches[0].clientX - rect.left;
            player.x = touchXInCanvas - player.width / 2;
        }
        function handleTouchEnd() { touchStartX = null; }

        function resizeCanvas() {
            const containerWidth = gameContainer.clientWidth || 800;
            canvasWidth = containerWidth;
            canvasHeight = containerWidth * 0.75;
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
        }

        window.addEventListener('keydown', handleKeyDown);
        window.addEventListener('keyup', handleKeyUp);
        canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
        canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
        canvas.addEventListener('touchend', handleTouchEnd);
        
        startButton.addEventListener('click', initGame);
        restartButton.addEventListener('click', initGame);
        levelStartButton.addEventListener('click', startLevel);
        window.addEventListener('resize', resizeCanvas);

        // Inicializar la vista
        resizeCanvas();
    </script>
</body>
</html>
ÔøΩ